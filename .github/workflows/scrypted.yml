name: Test Scrypted
on:
  workflow_dispatch:
    inputs:
      runner:
        required: true
        type: string
        default: ubuntu-24.04
      scrypted_version:
        required: true
        type: string
        default: latest
      server_address:
        required: false
        type: string
jobs:
  test:
    runs-on: ${{ inputs.runner }}
    
    steps:
      - name: Set cluster envs
        shell: bash
        run: |
          mkdir -p ~/.scrypted/volume
          if [[ "${{ inputs.server_address }}" == "" ]]; then
            # Server mode
            echo "SCRYPTED_CLUSTER_MODE=server" >> ~/.scrypted/volume/.env
            echo "SCRYPTED_CLUSTER_ADDRESS=0.0.0.0" >> ~/.scrypted/volume/.env
            echo "SCRYPTED_CLUSTER_SECRET=swordfish" >> ~/.scrypted/volume/.env
          else
            # Client mode
            echo "SCRYPTED_CLUSTER_MODE=client" >> ~/.scrypted/volume/.env
            echo "SCRYPTED_CLUSTER_SERVER=${{ inputs.server_address }}" >> ~/.scrypted/volume/.env
            echo "SCRYPTED_CLUSTER_SECRET=swordfish" >> ~/.scrypted/volume/.env
          fi

      - name: Install scrypted server
        uses: scryptedapp/setup-scrypted@v0.0.2
        with:
          version: ${{ inputs.scrypted_version }}

      - name: Run establish a cf tunnel
        uses: vmactions/cf-tunnel@main
        with:
          protocol: http
          port: 11080

      - uses: codetalkio/expose-tunnel@v1.5.0
        id: expose-tunnel
        with:
          service: bore.pub
          port: 10556

      - name: Accessing the tunnel url
        run: echo "Tunnel has been started at '${{ steps.expose-tunnel.outputs.tunnel-url }}'"

      - name: Wait to exit
        shell: bash
        run: |
          while [ ! -f ./continue ]; do sleep 5; done
